<!DOCTYPE html>
<html>
  <head>
    <title>ChatLoom</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      body {
        font-family: sans-serif;
        background: #000;
        color: white;
        display: flex;
        flex-direction: column;
        height: 100vh;
        margin: 0;
      }

      #login {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex-grow: 1;
      }

      #chat {
        flex-grow: 1;
        display: none;
        flex-direction: column;
      }

      #messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
      }

      #inputContainer {
        display: flex;
        padding: 10px;
        border-top: 1px solid #444;
      }

      input, button {
        font-size: 16px;
        padding: 10px;
      }

      #nameInput, #messageInput {
        flex: 1;
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <div id="login">
      <h2>Enter Password</h2>
      <input id="passwordInput" type="password" placeholder="Password" />
      <button onclick="checkPassword()">Enter</button>
    </div>

    <div id="chat">
      <div id="messages"></div>
      <div id="inputContainer">
        <input id="nameInput" placeholder="Name" />
        <input id="messageInput" placeholder="Message" />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <script>
      const SUPABASE_URL = 'https://YOUR_PROJECT.supabase.co';
      const SUPABASE_KEY = 'YOUR_ANON_KEY';

      let client;

      function checkPassword() {
        const input = document.getElementById('passwordInput').value.trim();
        if (!input) return alert("Please enter a password!");

        // Create the client *with the password header*
        client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
          global: {
            headers: {
              'chatloom-password': input
            }
          }
        });

        document.getElementById('login').style.display = 'none';
        document.getElementById('chat').style.display = 'flex';
        loadMessages();
        startRealtime();
      }

      async function loadMessages() {
        const { data, error } = await client.from('messages').select('*').order('timestamp', { ascending: true });
        if (error) {
          alert('Wrong password or error loading messages!');
          location.reload();
          return;
        }
        const messages = document.getElementById('messages');
        messages.innerHTML = '';
        data.forEach(msg => {
          const div = document.createElement('div');
          div.textContent = `${msg.name}: ${msg.text}`;
          messages.appendChild(div);
        });
        messages.scrollTop = messages.scrollHeight;
      }

      async function sendMessage() {
        const name = document.getElementById('nameInput').value.trim();
        const text = document.getElementById('messageInput').value.trim();
        if (!name || !text) return;

        await client.from('messages').insert([{ name, text }]);
        document.getElementById('messageInput').value = '';
      }

      function startRealtime() {
        client
          .channel('realtime:messages')
          .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'messages'
          }, payload => {
            const msg = payload.new;
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.textContent = `${msg.name}: ${msg.text}`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
          })
          .subscribe();
      }
    </script>
  </body>
</html>
